version: 2

resources:
  defaults: &defaults
    machine:
      java:
        version: openjdk8

    environment:
      _JAVA_OPTIONS: "-Xmx512m -Xms512m"

jobs:

  build_maven:
    <<: *defaults
    steps:
      - run:
          name: Maven build
          command: mvn clean verify -s settings.xml

      - run:
          name: Move Surefire test results
          command: |
            mkdir -p $CIRCLE_TEST_REPORTS/junit/
            find . -type f -regex ".*/target/surefire-reports/.*xml" -exec cp {} $CIRCLE_TEST_REPORTS/junit/ \;

  deploy:
    <<: *defaults
    steps:
      - deploy:
          name: Maven deploy
          command: mvn deploy -s settings.xml

      - deploy:
          name: Maven release
          commands: ./mvn-release.sh

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build_maven
      - deploy:
          requires:
            - build_maven
          filters:
            branches:
              only:
                - master
